# üìß H∆∞·ªõng d·∫´n Setup Email G·ª≠i V√© QR Code

## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ





## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ




## ‚úÖ ƒê√£ t·∫°o

1. ‚úÖ `lib/email.js` - Email service v·ªõi nodemailer
2. ‚úÖ `app/api/bookings/send-ticket/route.js` - API g·ª≠i email v√©
3. ‚úÖ `app/api/bookings/verify-qr/route.js` - API verify QR code t·∫°i r·∫°p
4. ‚úÖ T·ª± ƒë·ªông g·ª≠i email sau khi thanh to√°n th√†nh c√¥ng

## üìã C·∫•u h√¨nh Email

### B∆∞·ªõc 1: C·∫•u h√¨nh SMTP trong `.env`

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau:

```env
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

### B∆∞·ªõc 2: T·∫°o App Password cho Gmail

1. V√†o [Google Account](https://myaccount.google.com/)
2. Security ‚Üí 2-Step Verification (b·∫≠t n·∫øu ch∆∞a)
3. App passwords ‚Üí T·∫°o app password m·ªõi
4. Ch·ªçn "Mail" v√† "Other (Custom name)"
5. Copy password v√† d√°n v√†o `SMTP_PASS`

### B∆∞·ªõc 3: Ho·∫∑c d√πng Email Service kh√°c

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
```

**Mailgun:**
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=your-mailgun-username
SMTP_PASS=your-mailgun-password
```

## üóÑÔ∏è Database Migration

Ch·∫°y migration ƒë·ªÉ th√™m c√°c tr∆∞·ªùng m·ªõi:

```sql
ALTER TABLE bookings 
ADD COLUMN ticket_qr_code TEXT,
ADD COLUMN email_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN email_sent_at DATETIME;
```

Ho·∫∑c d√πng Prisma:
```bash
npx prisma migrate dev --name add_ticket_qr_email
```

## üöÄ C√°ch ho·∫°t ƒë·ªông

### 1. T·ª± ƒë·ªông g·ª≠i email sau thanh to√°n

Khi thanh to√°n th√†nh c√¥ng (t·ª´ cron job ho·∫∑c webhook):
- ‚úÖ T·ª± ƒë·ªông t·∫°o QR code cho v√©
- ‚úÖ G·ª≠i email v·ªõi QR code ƒë·∫øn kh√°ch h√†ng
- ‚úÖ L∆∞u QR code v√†o database

### 2. G·ª≠i email th·ªß c√¥ng

API: `POST /api/bookings/send-ticket`

```javascript
const response = await fetch('/api/bookings/send-ticket', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ booking_id: 123 })
});
```

### 3. Verify QR code t·∫°i r·∫°p

API: `POST /api/bookings/verify-qr`

**Request:**
```json
{
  "qr_data": "{\"type\":\"ticket\",\"booking_code\":\"ABC12345\",\"booking_id\":123}"
}
```

**Response (V√© h·ª£p l·ªá):**
```json
{
  "valid": true,
  "message": "V√© h·ª£p l·ªá",
  "booking": {
    "booking_code": "ABC12345",
    "movie": "ƒê·ªãa ƒê√†ng",
    "seats": ["A1", "A2"],
    "showtime": "2024-12-10T19:00:00Z"
  }
}
```

**Response (V√© kh√¥ng h·ª£p l·ªá):**
```json
{
  "valid": false,
  "error": "V√© ch∆∞a ƒë∆∞·ª£c thanh to√°n"
}
```

## üì± T·∫°o App Qu√©t QR cho Staff

B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt trang ƒë∆°n gi·∫£n cho staff ƒë·ªÉ qu√©t QR:

```javascript
// app/staff/scan-qr/page.jsx
"use client";
import { useState } from 'react';

export default function ScanQRPage() {
  const [qrData, setQrData] = useState('');
  const [result, setResult] = useState(null);

  const handleVerify = async () => {
    const res = await fetch('/api/bookings/verify-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: qrData }),
    });
    
    const data = await res.json();
    setResult(data);
  };

  return (
    <div>
      <input 
        type="text" 
        value={qrData}
        onChange={(e) => setQrData(e.target.value)}
        placeholder="Qu√©t ho·∫∑c nh·∫≠p QR code"
      />
      <button onClick={handleVerify}>X√°c th·ª±c</button>
      
      {result && (
        <div>
          {result.valid ? (
            <div style={{ color: 'green' }}>
              ‚úÖ {result.message}
              <p>Phim: {result.booking.movie}</p>
              <p>Gh·∫ø: {result.booking.seats.join(', ')}</p>
            </div>
          ) : (
            <div style={{ color: 'red' }}>
              ‚ùå {result.error}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## üß™ Test Email

### Test g·ª≠i email th·ªß c√¥ng:

```bash
# T·∫°o file test-email.js
node -e "
import('./lib/email.js').then(({ sendTicketEmail }) => {
  sendTicketEmail({
    id: 1,
    booking_code: 'TEST1234',
    movie: 'Test Movie',
    branch: 'Test Branch',
    screen: 'R·∫°p 01',
    showtime: new Date(),
    seats: ['A1', 'A2'],
    total_amount: 150000,
    payment_method: 'momo'
  }, 'your-email@example.com', 'Test User')
  .then(() => console.log('Email sent!'))
  .catch(err => console.error('Error:', err));
});
"
```

## üìù Email Template

Email template ƒë∆∞·ª£c t·∫°o trong `lib/email.js` v·ªõi:
- ‚úÖ QR code l·ªõn, d·ªÖ qu√©t
- ‚úÖ Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√©
- ‚úÖ Design ƒë·∫πp, responsive
- ‚úÖ Attachment QR code image

## ‚ö†Ô∏è L∆∞u √Ω

1. **Rate Limiting**: Gmail c√≥ gi·ªõi h·∫°n 500 email/ng√†y (free account)
2. **Spam**: ƒê·∫£m b·∫£o email kh√¥ng b·ªã v√†o spam
3. **Error Handling**: Email l·ªói kh√¥ng l√†m gi√°n ƒëo·∫°n payment flow
4. **Retry**: C√≥ th·ªÉ th√™m retry mechanism n·∫øu email fail

## üîß Troubleshooting

### Email kh√¥ng g·ª≠i ƒë∆∞·ª£c:
1. Ki·ªÉm tra SMTP credentials
2. Ki·ªÉm tra App Password (Gmail)
3. Ki·ªÉm tra firewall/network
4. Xem logs trong console

### QR code kh√¥ng hi·ªÉn th·ªã:
1. Ki·ªÉm tra `qrcode` package ƒë√£ c√†i
2. Ki·ªÉm tra base64 encoding
3. Test QR code generation ri√™ng

### Verify QR kh√¥ng ho·∫°t ƒë·ªông:
1. Ki·ªÉm tra user c√≥ role staff/admin
2. Ki·ªÉm tra booking ƒë√£ paid ch∆∞a
3. Ki·ªÉm tra th·ªùi gian (c√≥ th·ªÉ qu√©t tr∆∞·ªõc 60 ph√∫t)

---

**Sau khi c·∫•u h√¨nh xong, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª≠i email v√© v·ªõi QR code sau m·ªói l·∫ßn thanh to√°n th√†nh c√¥ng!** üéâ














